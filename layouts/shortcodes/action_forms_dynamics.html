{{ $data := $.Page.Resources.GetMatch (.Get "data") }}
{{ $idSuffix := now.UnixNano }}

<div class="vue-app" id="vueapp{{ $idSuffix }}">

  <div class="row">
    <div v-if="taskes">
      <div class="p-float-label col-md-12" v-for="item in taskes">
        <p-dropdown v-model="item.selected" :options="item.options" :optionLabel="item.name" :placeholder="item.name"
          :inputId="item.name" class="col-md-12 mb-3">
          <template #value="slotProps">
            <div v-if="slotProps.value" :title="slotProps.value.value" class="flex h-100 align-items-center"
              :class="{ noImg: item.noImg }">
              <img v-if="slotProps.value.img" class="selected-img" :alt="slotProps.value.name"
                :src="slotProps.value.img" />
              <div class="image-missing" v-else></div>
              <div class="text-capitalize option-name" v-text="slotProps.value.name"></div>
              <a class="text-xs" target="_blank" title="Knowledge Bases in OpenEASE"
                v-if="slotProps.value.knowledge_bases" :href="slotProps.value.knowledge_bases"
                onclick="event.stopPropagation()">Knowledge Bases</a>
            </div>
            <span v-else>
              <span v-text="slotProps.placeholder"></span>
            </span>
          </template>
          <template #option="slotProps">
            <div class="flex align-items-center" :title="slotProps.option.value" :class="{ noImg: item.noImg }">
              <img v-if="slotProps.option.img" class="option-img" :alt="slotProps.option.name"
                :src="slotProps.option.img" />
              <div class="image-missing" v-else></div>
              <div class="text-capitalize option-name" v-text="slotProps.option.name"></div>
              <a class="text-xs" target="_blank" title="Knowledge Bases in OpenEASE"
                v-if="slotProps.option.knowledge_bases" :href="slotProps.option.knowledge_bases"
                onclick="event.stopPropagation()">Knowledge Bases</a>
            </div>
          </template>
        </p-dropdown>
        <label :for="item.name" v-text="'Action Core'"></label>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="p-float-label col-md-6" v-for="item in robos">
      <p-dropdown v-model="item.selected" :options="item.options" :optionLabel="item.name" :placeholder="item.name"
        :inputId="item.name" class="col-md-12 mb-3">
        <template #value="slotProps">
          <div v-if="slotProps.value" :title="slotProps.value.value" class="flex h-100 align-items-center"
            :class="{ noImg: item.noImg }">
            <img v-if="slotProps.value.img" class="selected-img" :alt="slotProps.value.name"
              :src="slotProps.value.img" />
            <div class="image-missing" v-else></div>
            <div class="text-capitalize option-name" v-text="slotProps.value.name"></div>
            <a class="text-xs" target="_blank" title="Knowledge Bases in OpenEASE"
              v-if="slotProps.value.knowledge_bases" :href="slotProps.value.knowledge_bases"
              onclick="event.stopPropagation()">Knowledge Bases</a>
          </div>
          <span v-else>
            <span v-text="slotProps.placeholder"></span>
          </span>
        </template>
        <template #option="slotProps">
          <div class="flex align-items-center" :title="slotProps.option.value" :class="{ noImg: item.noImg }">
            <img v-if="slotProps.option.img" class="option-img" :alt="slotProps.option.name"
              :src="slotProps.option.img" />
            <div class="image-missing" v-else></div>
            <div class="text-capitalize option-name" v-text="slotProps.option.name"></div>
            <a class="text-xs" target="_blank" title="Knowledge Bases in OpenEASE"
              v-if="slotProps.option.knowledge_bases" :href="slotProps.option.knowledge_bases"
              onclick="event.stopPropagation()">Knowledge Bases</a>
          </div>
        </template>
      </p-dropdown>
      <label :for="item.name" v-text="item.name"></label>
    </div>


    <div class="p-float-label col-md-6" v-for="item in envs">
      <p-dropdown v-model="item.selected" :options="item.options" :optionLabel="item.name" :placeholder="item.name"
        :inputId="item.name" class="col-md-12 mb-3">
        <template #value="slotProps">
          <div v-if="slotProps.value" :title="slotProps.value.value" class="flex h-100 align-items-center"
            :class="{ noImg: item.noImg }">
            <img v-if="slotProps.value.img" class="selected-img" :alt="slotProps.value.name"
              :src="slotProps.value.img" />
            <div class="image-missing" v-else></div>
            <div class="text-capitalize option-name" v-text="slotProps.value.name"></div>
            <a class="text-xs" target="_blank" title="Knowledge Bases in OpenEASE"
              v-if="slotProps.value.knowledge_bases" :href="slotProps.value.knowledge_bases"
              onclick="event.stopPropagation()">Knowledge Bases</a>
          </div>
          <span v-else>
            <span v-text="slotProps.placeholder"></span>
          </span>
        </template>
        <template #option="slotProps">
          <div class="flex align-items-center" :title="slotProps.option.value" :class="{ noImg: item.noImg }">
            <img v-if="slotProps.option.img" class="option-img" :alt="slotProps.option.name"
              :src="slotProps.option.img" />
            <div class="image-missing" v-else></div>
            <div class="text-capitalize option-name" v-text="slotProps.option.name"></div>
            <a class="text-xs" target="_blank" title="Knowledge Bases in OpenEASE"
              v-if="slotProps.option.knowledge_bases" :href="slotProps.option.knowledge_bases"
              onclick="event.stopPropagation()">Knowledge Bases</a>
          </div>
        </template>
      </p-dropdown>
      <label :for="item.name" v-text="item.name"></label>
    </div>
  <!-- Specialized Task Dropdown, visible only if "cutting" is selected -->
    <!-- Specialized Task Dropdown, visible only if "cutting" is selected -->
    <div class="p-float-label col-md-6" v-if="showSpecializedCuttingDropdown">
        <p-dropdown class="dropdown-size" v-model="selectedSpecializedCuttingTask" :options="specializedCuttingTasks" optionLabel="name"
        placeholder="Specialized Cutting Task" inputId="specializedTaskDropdown" class="col-md-12 mb-3">
        <template #value="slotProps">
          <div v-if="slotProps.value" :title="slotProps.value.value" class="flex h-100 align-items-center">
            <div class="text-capitalize option-name" v-text="slotProps.value.name"></div>
          </div>
          <span v-else>
            <span v-text="slotProps.placeholder"></span>
          </span>
        </template>
        <template #option="slotProps">
          <div class="flex align-items-center" :title="slotProps.option.value">
            <div class="text-capitalize option-name" v-text="slotProps.option.name"></div>
          </div>
        </template>
      </p-dropdown>
       <label :for="selectedSpecializedCuttingTask" v-text="'Specialization'"></label>

  </div>

    <!-- Specialized Task Dropdown, visible only if "mixing" is selected -->
    <div class="p-float-label col-md-6" v-if="showSpecializedMixingDropdown">
      <p-dropdown class="dropdown-size" v-model="selectedSpecializedMixingTask" :options="specializedMixingTasks" optionLabel="name"
        placeholder="Specialized Mixing Task" inputId="specializedMixingDropdown" class="col-md-12 mb-3">
        <template #value="slotProps">
          <div v-if="slotProps.value" :title="slotProps.value.value" class="flex h-100 align-items-center">
            <div class="text-capitalize option-name" v-text="slotProps.value.name"></div>
          </div>
          <span v-else>
            <span v-text="slotProps.placeholder"></span>
          </span>
        </template>
        <template #option="slotProps">
          <div class="flex align-items-center" :title="slotProps.option.value">
            <div class="text-capitalize option-name" v-text="slotProps.option.name"></div>
          </div>
        </template>
      </p-dropdown>
      <label :for="selectedSpecializedMixingTask" v-text="'Specialization'"></label>
    </div>

        <!-- Specialized Task Dropdown, visible only if "mixing" is selected -->
    <div class="p-float-label col-md-6" v-if="showSpecializedPouringDropdown">
      <p-dropdown class="dropdown-size" v-model="selectedSpecializedPouringTask" :options="specializedPouringTasks" optionLabel="name"
        placeholder="Specialized Pouring Task" inputId="specializedPouringDropdown" class="col-md-12 mb-3">
        <template #value="slotProps">
          <div v-if="slotProps.value" :title="slotProps.value.value" class="flex h-100 align-items-center">
            <div class="text-capitalize option-name" v-text="slotProps.value.name"></div>
          </div>
          <span v-else>
            <span v-text="slotProps.placeholder"></span>
          </span>
        </template>
        <template #option="slotProps">
          <div class="flex align-items-center" :title="slotProps.option.value">
            <div class="text-capitalize option-name" v-text="slotProps.option.name"></div>
          </div>
        </template>
      </p-dropdown>
      <label :for="selectedSpecializedPouringTask" v-text="'Specialization'"></label>
    </div>

              <!-- Specialized Task Dropdown, visible only if "mixing" is selected -->
    <div class="p-float-label col-md-6" v-if="showSpecializedTransportingDropdown">
      <p-dropdown class="dropdown-size" v-model="selectedSpecializedTransportingTask" :options="specializedTransportingTasks" optionLabel="name"
        placeholder="Specialized Transporting Task" inputId="specializedTransportingDropdown" class="col-md-12 mb-3">
        <template #value="slotProps">
          <div v-if="slotProps.value" :title="slotProps.value.value" class="flex h-100 align-items-center">
            <div class="text-capitalize option-name" v-text="slotProps.value.name"></div>
          </div>
          <span v-else>
            <span v-text="slotProps.placeholder"></span>
          </span>
        </template>
        <template #option="slotProps">
          <div class="flex align-items-center" :title="slotProps.option.value">
            <div class="text-capitalize option-name" v-text="slotProps.option.name"></div>
          </div>
        </template>
      </p-dropdown>
      <label :for="selectedSpecializedTransportingTask" v-text="'Specialization'"></label>
    </div>
    </div>



     <!-- Buttons -->
  <div class="action-buttons">
    <div class="action-button-wrapper" v-for="action in actions" :class="{ 'disabled-action-button-wrapper': !getActionUrl(action) }">
      <a class="btn mr-2 mb-2 " target="_blank" v-text="action.name" :title="action.description"
        :href="getActionUrl(action)"
        :class="{ 'btn-primary': action.primary,'btn-success': !action.primary, 'disabled': !getActionUrl(action) }"></a>
    </div>
  </div>
  </div>
  <!-- error message -->
  <div v-show="errorMsgs.length !== 0">
    <pre class="alert alert-warning" v-text="errorMsgs"></pre>
  </div>

<script type="module">

  function isAbsoluteUrl(url) {
    return /^([a-z][a-z\d+\-.]*:)?\/\//i.test(url) || /^data:/i.test(url);
  }
  const { createApp, ref } = Vue;
  const data = JSON.parse({{ $data.Content }})
  const App = {
    data() {
      return {
        actions: data.actions,
        selectOptions: this.buildOptions('options'),
        updatedOptions: this.buildOptions('options'),
         specializedCuttingTasks: [
          { name: "Halving", value: "halving" },
          { name: "Slicing", value: "slicing" },
           { name: "Sawing", value: "sawing" }
        ],
        selectedSpecializedCuttingTask: {name: "Halving", value: "halving"},

        specializedPouringTasks: [
          { name: "Pouring", value: "pour" },
          // { name: "Draining", value: "drain" },
          // { name: "Sprinkling", value: "sprinkle" }
        ],
        selectedSpecializedPouringTask: {name: "Pouring", value: "pour"},

         specializedTransportingTasks: [
          { name: "Setting the Table", value: "set" },
          { name: "Cleaning the Table", value: "clean" }
        ],
        selectedSpecializedTransportingTask: {name: "Setting the Table", value: "set"},
         // Define specialized mixing tasks here
        specializedMixingTasks: [
          // { name: "Stirring", value: "stirring" },
          { name: "Whisking", value: "whisking" }
        ],
        selectedSpecializedMixingTask: { name: "Whisking", value: "whisking" }

      };
    },
    computed: {
      showSpecializedCuttingDropdown() {
        // Show the specialized dropdown only if the selected task is "cutting"
        return this.taskes && this.taskes.length > 0 && this.taskes[0].selected && this.taskes[0].selected.value === "cutting";

      },
       showSpecializedMixingDropdown() {
    // Show the specialized dropdown only if the selected task is "mixing"
      return this.taskes && this.taskes.length > 0 && this.taskes[0].selected && this.taskes[0].selected.value === "mixing";
    },
          showSpecializedPouringDropdown() {
    // Show the specialized dropdown only if the selected task is "mixing"
      return this.taskes && this.taskes.length > 0 && this.taskes[0].selected && this.taskes[0].selected.value === "pouring";
    },
      showSpecializedTransportingDropdown() {
    // Show the specialized dropdown only if the selected task is "mixing"
      return this.taskes && this.taskes.length > 0 && this.taskes[0].selected && this.taskes[0].selected.value === "transporting";
    },
      selectedNotebookId() {
        const newValue = this.selectOptions
          ? this.selectOptions.map(v => v.name + '=' + v.selected.value).join('|')
          : ''
        return newValue
      },
      selectedNotebookIdUpdated() {
        const newValue = this.selectOptions
          ? this.updatedOptions.map(v => v.name + '=' + v.selected.value).join('|')
          : ''
        return newValue
      },
      errorMsgs() {
        let _arr = this.actions
          .filter(act => !this.getActionUrl(act))
          .map(act => `"${act.name}"`)
        let selectionStr = this.selectedNotebookId
          ? ` for options: \n\n${this.selectedNotebookId.replace(/\|/g, '\n')}`
          : '!'
        return _arr.length === 0 ? '' : `${_arr.join(',')} is currently unavailable${selectionStr}`
      },
      envs() {
        this.filterOptions()
        return this.updatedOptions.length > 0 ? [this.updatedOptions[0]] : [];
        // return this.selectOptions.length > 0 ? [this.selectOptions[0]] : [];
      },
      robos() {
        const selectedEnvironment = this.updatedOptions[0].selected.value;
        this.filterOptions(selectedEnvironment)
        return this.updatedOptions.length > 1 ? [this.updatedOptions[1]] : [];
        // return this.selectOptions.length > 0 ? [this.selectOptions[1]] : [];
      },
      taskes() {
        if (this.selectOptions.length > 2){
          const selectedEnvironment = this.updatedOptions[0].selected.value;
          const selectedRobot = this.updatedOptions[1].selected.value;
          this.filterOptions(selectedEnvironment,selectedRobot)
          return this.updatedOptions.length > 2 ? [this.updatedOptions[2]] : [];
        }
        return this.selectOptions.length > 2 ? [this.selectOptions[2]] : null;
      }
    },
    methods: {
       buildOptions(type) {
         return Object.keys(data[type]).map(v => {
           return {
             name: v,
             selected: data[type][v][0],
             options: data[type][v]
           };
         })
       },
    getActionUrl(action) {
  // Build the selected options string
  let selectedOptions = this.updatedOptions.map(option => {
    return `${option.name}=${option.selected.value}`;
  }).join('|');

  // Check if a specialized task is selected and append it to selectedOptions
  if (this.showSpecializedCuttingDropdown) {
    selectedOptions += `|specializedCuttingTask=${this.selectedSpecializedCuttingTask.value}`;
  } else if (this.showSpecializedMixingDropdown) {
    selectedOptions += `|specializedMixingTask=${this.selectedSpecializedMixingTask.value}`;
  } else if (this.showSpecializedPouringDropdown) {
    selectedOptions += `|specializedPouringTask=${this.selectedSpecializedPouringTask.value}`;
  } else if (this.showSpecializedTransportingDropdown) {
    selectedOptions += `|specializedTransportingTask=${this.selectedSpecializedTransportingTask.value}`;
  }

  // Check if there's an available URL for the selected options
  let _url = action.available[selectedOptions];

  // If there's no available URL, use the main URL
  if (!_url) _url = action.url;
  if (!_url) return '';

  // Build query string from selected options
  let queryParams = this.updatedOptions.map(option => {
    return `${option.name}=${option.selected.value}`;
  }).join('&');

  // Check if a specialized task is selected and append it to the query string
  let specialParam = '';
  if (this.showSpecializedCuttingDropdown) {
    specialParam = `&specialized_task=${this.selectedSpecializedCuttingTask.value}`;
  } else if (this.showSpecializedMixingDropdown) {
    specialParam =  `&specialized_task=${this.selectedSpecializedMixingTask.value}`;
  } else if (this.showSpecializedPouringDropdown) {
    specialParam =  `&specialized_task=${this.selectedSpecializedPouringTask.value}`;
  } else if (this.showSpecializedTransportingDropdown) {
    specialParam =  `&specialized_task=${this.selectedSpecializedTransportingTask.value}`;
  }

  // Append specialParam to queryParams
  queryParams += specialParam;

  // Manually encode the entire query string, including ?, &, and =
  const encodedQueryParams = encodeURIComponent(`?${queryParams}`);

  // Append query string to the URL
  _url += encodedQueryParams;

  return _url;
},

      filterOptions(selectedEnv = '',selectedRobo = ''){
        const availableConfigs = this.actions.reduce((acc, action) => ({...acc, ...action.available}), {});

        if (availableConfigs !== null){
          const OptionSet = new Set();
          let OptionList = []
          let regex = '';
          let optionIndex = 1;

          if (selectedEnv === '') {
              regex = new RegExp(`environments=([^|]+)`);
              optionIndex = 0
          }
          else if (selectedRobo === ''){
              regex = new RegExp(`environments=${selectedEnv}\\|robots=([^|]+)`);
              optionIndex = 1
          }
          else {
              regex = new RegExp(`environments=${selectedEnv}\\|robots=${selectedRobo}\\|tasks=([^|]+)`);
              optionIndex = 2
          }

          for (const key in availableConfigs) {
              const match = regex.exec(key);
              if (match) {
              for (const ind in this.selectOptions[optionIndex].options){
                  const dicts = this.selectOptions[optionIndex].options[ind]
                  const name = dicts['name']
                  if ((dicts['value'] === match[1]) && (!OptionSet.has(name)))
                  {
                  OptionSet.add(name);
                  OptionList.push(dicts);
                  }
              }
              }
          }

          // //Sorting available options alphabetically
          // OptionList.sort(function(a,b){
          //   var nameA = a.name.toUpperCase();
          //   var nameB = b.name.toUpperCase();
          //   if (nameA < nameB){
          //     return -1;
          //   }
          //   if (nameA > nameB){
          //     return 1;
          //   }
          //   return 0;
          // })

          this.updatedOptions[optionIndex].options = []
          this.updatedOptions[optionIndex].options = Array.from(OptionList)
          this.updatedOptions[optionIndex].selected = this.updatedOptions[optionIndex].options[0]

        }
        // return OptionList;
      }
    },
    components: {
      "p-button": primevue.button,
      "p-overlaypanel": primevue.overlaypanel,
      "p-dropdown": primevue.dropdown
    }
  };

  const app = createApp(App);
  app.use(primevue.config.default);
  app.mount('#vueapp{{ $idSuffix }}');
</script>
